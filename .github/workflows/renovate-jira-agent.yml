name: Renovate -> Jira automation

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  SCHEDULE_ENABLED: "false" # Set to "true" to allow scheduled runs
  JIRA_BASE_URL: "https://tools.hmcts.net/jira"

permissions:
  contents: read
  pull-requests: write

jobs:
  run-agent:
    if: ${{ github.event_name != 'schedule' || env.SCHEDULE_ENABLED == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Renovate->Jira agent
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

          # Target selection (choose one)
          # GITHUB_REPO: ${{ github.repository }}
          # REPO_LIST: "owner/repo1,owner/repo2"
          # ORG_NAME: "my-org"
          # REPO_TOPIC_FILTER: "renovate-enabled"
          REPO_LIST_FILE: ./repo-list.txt

          JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
          JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}
          JIRA_PROJECT_KEY: ${{ secrets.JIRA_PROJECT_KEY }}
          JIRA_API_VERSION: "2"

          MODE: "dry-run" # Set to "run" to create Jira tickets, "dry-run" for testing only
          VERBOSE: "1" # If MODE=run, set to "0" to reduce log verbosity
          FIX_TICKET_LABELS: "false" # Set to "true" to amend labels/epic/fixVersion on existing tickets
          FIX_TICKET_LABELS_EVEN_IN_DRY_MODE: "false" # Set to "true" to update tickets even when MODE=dry-run
        run: python main.py
