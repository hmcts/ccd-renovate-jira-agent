name: Renovate -> Jira automation

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  JIRA_BASE_URL: "https://tools.hmcts.net/jira"
  JIRA_PROJECT_KEY: "CCD"
  JIRA_EPIC_KEY: "CCD-7071"
  JIRA_EPIC_LINK_FIELD: "customfield_10008"
  JIRA_FIX_VERSION: "CCD CI/CD Release"
  JIRA_RELEASE_APPROACH_VALUE: "Tier 1: CI/CD"

permissions:
  contents: read
  pull-requests: write

jobs:
  run-agent:
    # Scheduled runs are disabled because the condition is false for the schedule event.
    # Set `false` to `true` to allow schedule triggers.
    if: ${{ github.event_name != 'schedule' || false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Renovate->Jira agent
        env:
          GITHUB_TOKEN: ${{ secrets.RENOVATE_GITHUB_TOKEN }}

          # Target selection (choose one)
          # GITHUB_REPO: ${{ github.repository }}
          # REPO_LIST: "owner/repo1,owner/repo2"
          # ORG_NAME: "my-org"
          # REPO_TOPIC_FILTER: "renovate-enabled"
          REPO_LIST_FILE: ./repo-list.txt

          JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
          
          #JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          #JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

          #If using PAT authentication, use JIRA_PAT instead of the above two variables
          JIRA_PAT: ${{ secrets.JIRA_PAT }}
          
          JIRA_PROJECT_KEY: ${{ env.JIRA_PROJECT_KEY }}
          JIRA_EPIC_KEY: ${{ env.JIRA_EPIC_KEY }}
          JIRA_EPIC_LINK_FIELD: ${{ env.JIRA_EPIC_LINK_FIELD }}
          JIRA_FIX_VERSION: ${{ env.JIRA_FIX_VERSION }}
          JIRA_RELEASE_APPROACH_VALUE: ${{ env.JIRA_RELEASE_APPROACH_VALUE }}
          JIRA_API_VERSION: "2"

          MODE: "dry-run" # Set to "run" to create Jira tickets, "dry-run" for testing only
          VERBOSE: "1" # If MODE=run, set to "0" to reduce log verbosity

          # if testing only, grab only one renovate PR to process, create only one Jira ticket to confirm logic is correct
          # TEST_PR_NUMBER: "https://github.com/hmcts/ccd-case-print-service/pull/600" # Optional: process only this PR number
          # MAX_NEW_JIRA_TICKETS: "1" # Optional: stop after creating this many new Jira tickets, good for testing
          
          FIX_TICKET_LABELS: "true" # Set to "true" to amend labels/epic/fixVersion/release approach on existing tickets
          FIX_TICKET_LABELS_EVEN_IN_DRY_MODE: "true" # Set to "true" to update tickets even when MODE=dry-run
          FIX_TICKET_PR_LINKS: "false" # Set to "true" to add PR links to existing Jira tickets
          
          VERBOSE_JIRA_DEDUPE: "false" # Set to "true" for extra Jira dedupe diagnostics (will log all Jira tickets considered for deduplication and why they were or were not considered a match)
          LOCAL_CONFIG_PATH: .github/renovate-jira.yml # Use config from this repo for all targets
          CREATE_PR_LINKS: "true" # Set to "true" to add PR links on new Jira tickets
          JIRA_TARGET_STATUS: "Resume Development" # Optional: transition tickets to this status
          JIRA_TARGET_STATUS_PATH: "Blocked,Resume Development" # Optional: comma-separated transition path
          JIRA_SKIP_STATUSES: "Resume Development,Resume QA,Resume Release" # Optional: skip tickets in these statuses
        run: python main.py
