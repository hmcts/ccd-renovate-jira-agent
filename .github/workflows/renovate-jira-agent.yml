name: Renovate -> Jira automation

on:
  schedule:
    - cron: "0 2 * * *"
  workflow_dispatch:

env:
  JIRA_BASE_URL: "https://tools.hmcts.net/jira"
  JIRA_PROJECT_KEY: "CCD"

permissions:
  contents: read
  pull-requests: write

jobs:
  run-agent:
    # Scheduled runs are disabled because the condition is false for the schedule event.
    # Set `false` to `true` to allow schedule triggers.
    if: ${{ github.event_name != 'schedule' || false }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run Renovate->Jira agent
        env:
          GITHUB_TOKEN: ${{ secrets.RENOVATE_GITHUB_TOKEN }}

          # Target selection (choose one)
          # GITHUB_REPO: ${{ github.repository }}
          # REPO_LIST: "owner/repo1,owner/repo2"
          # ORG_NAME: "my-org"
          # REPO_TOPIC_FILTER: "renovate-enabled"
          REPO_LIST_FILE: ./repo-list.txt

          JIRA_BASE_URL: ${{ env.JIRA_BASE_URL }}
          
          #JIRA_USER_EMAIL: ${{ secrets.JIRA_USER_EMAIL }}
          #JIRA_API_TOKEN: ${{ secrets.JIRA_API_TOKEN }}

          #If using PAT authentication, use JIRA_PAT instead of the above two variables
          JIRA_PAT: ${{ secrets.JIRA_PAT }}
          
          JIRA_PROJECT_KEY: ${{ env.JIRA_PROJECT_KEY }}
          JIRA_API_VERSION: "2"

          MODE: "dry-run" # Set to "run" to create Jira tickets, "dry-run" for testing only
          VERBOSE: "1" # If MODE=run, set to "0" to reduce log verbosity
          FIX_TICKET_LABELS: "false" # Set to "true" to amend labels/epic/fixVersion on existing tickets
          FIX_TICKET_LABELS_EVEN_IN_DRY_MODE: "false" # Set to "true" to update tickets even when MODE=dry-run
          FIX_TICKET_PR_LINKS: "false" # Set to "true" to add PR links to existing Jira tickets
          VERBOSE_JIRA_DEDUPE: "false" # Set to "true" for extra Jira dedupe diagnostics
          LOCAL_CONFIG_PATH: .github/renovate-jira.yml # Use config from this repo for all targets
          CREATE_PR_LINKS: "true" # Set to "true" to add PR links on new Jira tickets
          JIRA_TARGET_STATUS: "Resume Development" # Optional: transition tickets to this status
          JIRA_TARGET_STATUS_PATH: "Blocked,Resume Development" # Optional: comma-separated transition path
          JIRA_SKIP_STATUSES: "Resume Development,Resume QA,Resume Release" # Optional: skip tickets in these statuses
        run: python main.py
